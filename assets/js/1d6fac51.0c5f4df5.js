"use strict";(globalThis.webpackChunkuip_urban_intelligence_platform_docs=globalThis.webpackChunkuip_urban_intelligence_platform_docs||[]).push([[7426],{7575:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"backend/services/neo4j-service","title":"Neo4jService - Graph Database Client","description":"TypeScript client for Neo4j graph database providing entity relationship querying, graph traversal, and semantic network analysis.","source":"@site/docs/backend/services/neo4jService.md","sourceDirName":"backend/services","slug":"/backend/services/neo4j-service","permalink":"/tes/docs/backend/services/neo4j-service","draft":false,"unlisted":false,"editUrl":"https://github.com/NguyenNhatquang522004/UIP-Urban_Intelligence_Platform/tree/main/apps/traffic-web-app/frontend/docs/docs/backend/services/neo4jService.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"neo4j-service","title":"Neo4jService - Graph Database Client","sidebar_label":"Neo4jService","sidebar_position":2,"description":"TypeScript client for Neo4j graph database providing entity relationship querying, graph traversal, and semantic network analysis.","keywords":["neo4j","graph","cypher","relationships","traversal","accidents"]}}');var a=r(4848),t=r(8453);const s={id:"neo4j-service",title:"Neo4jService - Graph Database Client",sidebar_label:"Neo4jService",sidebar_position:2,description:"TypeScript client for Neo4j graph database providing entity relationship querying, graph traversal, and semantic network analysis.",keywords:["neo4j","graph","cypher","relationships","traversal","accidents"]},c="Neo4jService - Graph Database Client",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Class Definition",id:"class-definition",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Basic Accident Queries",id:"basic-accident-queries",level:3},{value:"Geo-Spatial Queries",id:"geo-spatial-queries",level:3},{value:"Relationship Traversal",id:"relationship-traversal",level:3},{value:"Cypher Query Examples",id:"cypher-query-examples",level:2},{value:"Get Accidents with Ordering",id:"get-accidents-with-ordering",level:3},{value:"Geo-Spatial Distance Query",id:"geo-spatial-distance-query",level:3},{value:"Relationship Discovery",id:"relationship-discovery",level:3},{value:"Find Related Cameras",id:"find-related-cameras",level:3},{value:"Weather-Accident Correlation",id:"weather-accident-correlation",level:3},{value:"Data Model",id:"data-model",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Session Management",id:"session-management",level:2},{value:"Use Cases",id:"use-cases",level:2},{value:"1. Accident Correlation Analysis",id:"1-accident-correlation-analysis",level:3},{value:"2. Camera Coverage Analysis",id:"2-camera-coverage-analysis",level:3},{value:"3. Weather Impact Analysis",id:"3-weather-impact-analysis",level:3},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"Recommended Indexes",id:"recommended-indexes",level:3},{value:"Related Documentation",id:"related-documentation",level:2},{value:"References",id:"references",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"neo4jservice---graph-database-client",children:"Neo4jService - Graph Database Client"})}),"\n",(0,a.jsxs)(n.p,{children:["TypeScript client for ",(0,a.jsx)(n.strong,{children:"Neo4j"})," graph database providing entity relationship querying, graph traversal, and semantic network analysis for traffic and environmental data."]}),"\n",(0,a.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-mermaid",children:'graph TB\r\n    subgraph Neo4jService\r\n        DRIVER[Neo4j Driver]\r\n        SESSION[Session Manager]\r\n        QUERY[Cypher Executor]\r\n    end\r\n    \r\n    subgraph Neo4j["Neo4j Database"]\r\n        ACCIDENTS[(Accidents)]\r\n        CAMERAS[(Cameras)]\r\n        ROADS[(Road Segments)]\r\n        WEATHER[(Weather)]\r\n    end\r\n    \r\n    subgraph Relationships\r\n        NEAR[NEAR_TO]\r\n        CAUSED[CAUSED_BY]\r\n        AFFECTS[AFFECTS]\r\n        LOCATED[LOCATED_ON]\r\n    end\r\n    \r\n    DRIVER --\x3e SESSION\r\n    SESSION --\x3e QUERY\r\n    QUERY --\x3e ACCIDENTS\r\n    QUERY --\x3e CAMERAS\r\n    \r\n    ACCIDENTS --- NEAR\r\n    ACCIDENTS --- CAUSED\r\n    CAMERAS --- LOCATED\r\n    WEATHER --- AFFECTS\n'})}),"\n",(0,a.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Feature"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Cypher Queries"})}),(0,a.jsx)(n.td,{children:"Parameterized query execution with binding"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Relationship Traversal"})}),(0,a.jsx)(n.td,{children:"Multi-hop queries for connected entities"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Accident Analysis"})}),(0,a.jsx)(n.td,{children:"Correlation and clustering of incidents"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Geo-Spatial Queries"})}),(0,a.jsx)(n.td,{children:"Distance-based relationship discovery"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Connection Pooling"})}),(0,a.jsx)(n.td,{children:"Timeout management and recovery"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Transaction Support"})}),(0,a.jsx)(n.td,{children:"Read/write transaction isolation"})]})]})]}),"\n",(0,a.jsx)(n.h2,{id:"class-definition",children:"Class Definition"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"import neo4j, { Driver, Session } from 'neo4j-driver';\r\n\r\nexport class Neo4jService {\r\n  private driver: Driver;\r\n\r\n  constructor();\r\n  \r\n  // Accident Queries\r\n  getAccidents(): Promise<Accident[]>;\r\n  getAccidentById(id: string): Promise<Accident | null>;\r\n  getAccidentsByArea(lat: number, lon: number, radiusKm?: number): Promise<Accident[]>;\r\n  getAccidentRelationships(accidentId: string): Promise<Relationship[]>;\r\n  \r\n  // Connection Management\r\n  close(): Promise<void>;\r\n}\r\n\r\ninterface Relationship {\r\n  relationship: string;\r\n  relatedType: string;\r\n  related: Record<string, any>;\r\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Environment Variables\r\nconst config = {\r\n  NEO4J_URL: 'bolt://localhost:7687',\r\n  NEO4J_USER: 'neo4j',\r\n  NEO4J_PASSWORD: 'test12345'\r\n};\r\n\r\n// Driver Options\r\nconst driverConfig = {\r\n  connectionTimeout: 10000,         // 10s connection timeout\r\n  maxConnectionLifetime: 3600000    // 1 hour max connection lifetime\r\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,a.jsx)(n.h3,{id:"basic-accident-queries",children:"Basic Accident Queries"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"import { Neo4jService } from './services/neo4jService';\r\n\r\nconst neo4j = new Neo4jService();\r\n\r\n// Get all accidents (latest 100)\r\nconst accidents = await neo4j.getAccidents();\r\nconsole.log(`Found ${accidents.length} accidents`);\r\n\r\n// Get single accident by ID\r\nconst accident = await neo4j.getAccidentById('urn:ngsi-ld:RoadAccident:001');\r\nif (accident) {\r\n  console.log(`Accident at ${accident.location.address}`);\r\n  console.log(`Severity: ${accident.severity}`);\r\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"geo-spatial-queries",children:"Geo-Spatial Queries"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Find accidents within 5km of a location\r\nconst nearbyAccidents = await neo4j.getAccidentsByArea(\r\n  10.8231,  // latitude\r\n  106.6297, // longitude\r\n  5         // radius in km\r\n);\r\n\r\nconsole.log(`Found ${nearbyAccidents.length} accidents nearby`);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"relationship-traversal",children:"Relationship Traversal"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Get all relationships for an accident\r\nconst relationships = await neo4j.getAccidentRelationships('urn:ngsi-ld:RoadAccident:001');\r\n\r\nrelationships.forEach(rel => {\r\n  console.log(`${rel.relationship} -> ${rel.relatedType}`);\r\n  console.log(rel.related);\r\n});\n"})}),"\n",(0,a.jsx)(n.h2,{id:"cypher-query-examples",children:"Cypher Query Examples"}),"\n",(0,a.jsx)(n.h3,{id:"get-accidents-with-ordering",children:"Get Accidents with Ordering"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"MATCH (a:Accident)\r\nRETURN a\r\nORDER BY a.timestamp DESC\r\nLIMIT 100\n"})}),"\n",(0,a.jsx)(n.h3,{id:"geo-spatial-distance-query",children:"Geo-Spatial Distance Query"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"MATCH (a:Accident)\r\nWITH a, \r\n     point({latitude: toFloat(a.latitude), longitude: toFloat(a.longitude)}) AS accidentPoint,\r\n     point({latitude: $latitude, longitude: $longitude}) AS centerPoint\r\nWHERE distance(accidentPoint, centerPoint) <= $radiusMeters\r\nRETURN a\r\nORDER BY a.timestamp DESC\n"})}),"\n",(0,a.jsx)(n.h3,{id:"relationship-discovery",children:"Relationship Discovery"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"MATCH (a:Accident {id: $id})-[r]-(related)\r\nRETURN type(r) AS relationship, labels(related) AS relatedType, related\n"})}),"\n",(0,a.jsx)(n.h3,{id:"find-related-cameras",children:"Find Related Cameras"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"MATCH (a:Accident {id: $accidentId})-[:NEAR_TO]->(c:Camera)\r\nRETURN c\r\nORDER BY c.distance ASC\r\nLIMIT 5\n"})}),"\n",(0,a.jsx)(n.h3,{id:"weather-accident-correlation",children:"Weather-Accident Correlation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"MATCH (a:Accident)-[:OCCURRED_DURING]->(w:Weather)\r\nWHERE w.precipitation > 0.5\r\nRETURN a, w\r\nORDER BY a.timestamp DESC\n"})}),"\n",(0,a.jsx)(n.h2,{id:"data-model",children:"Data Model"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-mermaid",children:"erDiagram\r\n    Accident ||--o{ Camera : NEAR_TO\r\n    Accident ||--o{ Weather : OCCURRED_DURING\r\n    Accident ||--o{ RoadSegment : LOCATED_ON\r\n    Camera ||--o{ RoadSegment : MONITORS\r\n    Weather ||--o{ AirQuality : AFFECTS\r\n    \r\n    Accident {\r\n        string id PK\r\n        float latitude\r\n        float longitude\r\n        string address\r\n        string type\r\n        string severity\r\n        string description\r\n        datetime timestamp\r\n        boolean resolved\r\n        int casualties\r\n    }\r\n    \r\n    Camera {\r\n        string id PK\r\n        float latitude\r\n        float longitude\r\n        string name\r\n        string imageUrl\r\n    }\r\n    \r\n    Weather {\r\n        string id PK\r\n        float temperature\r\n        float humidity\r\n        float precipitation\r\n        datetime observedAt\r\n    }\n"})}),"\n",(0,a.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"async getAccidentById(id: string): Promise<Accident | null> {\r\n  const session: Session = this.driver.session();\r\n  try {\r\n    const result = await session.run(\r\n      'MATCH (a:Accident {id: $id}) RETURN a',\r\n      { id }\r\n    );\r\n\r\n    if (result.records.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    return this.mapAccident(result.records[0].get('a').properties);\r\n  } catch (error) {\r\n    logger.error(`Error fetching accident ${id}:`, error);\r\n    return null;\r\n  } finally {\r\n    await session.close();  // Always close session\r\n  }\r\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"session-management",children:"Session Management"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-mermaid",children:"sequenceDiagram\r\n    participant Service\r\n    participant Driver\r\n    participant Session\r\n    participant Neo4j\r\n    \r\n    Service->>Driver: Get session\r\n    Driver->>Session: Create session\r\n    Service->>Session: Run query\r\n    Session->>Neo4j: Execute Cypher\r\n    Neo4j--\x3e>Session: Results\r\n    Session--\x3e>Service: Records\r\n    Service->>Session: Close session\n"})}),"\n",(0,a.jsx)(n.p,{children:"Important: Always close sessions after use to prevent connection leaks."}),"\n",(0,a.jsx)(n.h2,{id:"use-cases",children:"Use Cases"}),"\n",(0,a.jsx)(n.h3,{id:"1-accident-correlation-analysis",children:"1. Accident Correlation Analysis"}),"\n",(0,a.jsx)(n.p,{children:"Find accidents that occurred under similar conditions:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Find correlated accidents (same road, similar time)\r\nconst query = `\r\n  MATCH (a1:Accident {id: $id})-[:LOCATED_ON]->(r:RoadSegment)<-[:LOCATED_ON]-(a2:Accident)\r\n  WHERE a1 <> a2 \r\n    AND abs(duration.between(a1.timestamp, a2.timestamp).hours) < 24\r\n  RETURN a2\r\n`;\n"})}),"\n",(0,a.jsx)(n.h3,{id:"2-camera-coverage-analysis",children:"2. Camera Coverage Analysis"}),"\n",(0,a.jsx)(n.p,{children:"Find cameras that could have recorded an accident:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const query = `\r\n  MATCH (a:Accident {id: $id})\r\n  WITH a, point({latitude: a.latitude, longitude: a.longitude}) AS accidentPoint\r\n  MATCH (c:Camera)\r\n  WITH c, a, point({latitude: c.latitude, longitude: c.longitude}) AS cameraPoint\r\n  WHERE distance(accidentPoint, cameraPoint) <= 500  // 500m radius\r\n  RETURN c\r\n  ORDER BY distance(accidentPoint, cameraPoint) ASC\r\n`;\n"})}),"\n",(0,a.jsx)(n.h3,{id:"3-weather-impact-analysis",children:"3. Weather Impact Analysis"}),"\n",(0,a.jsx)(n.p,{children:"Analyze how weather affects accident frequency:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const query = `\r\n  MATCH (a:Accident)-[:OCCURRED_DURING]->(w:Weather)\r\n  WITH w.precipitation > 0.5 AS rainy, count(a) AS accidentCount\r\n  RETURN rainy, accidentCount\r\n`;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Aspect"}),(0,a.jsx)(n.th,{children:"Recommendation"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Session Lifecycle"})}),(0,a.jsx)(n.td,{children:"Create per-query, close immediately"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Indexes"})}),(0,a.jsx)(n.td,{children:"Create on frequently queried properties (id, timestamp)"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Query Optimization"})}),(0,a.jsx)(n.td,{children:"Use LIMIT, avoid unbounded traversals"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.strong,{children:"Connection Pooling"})}),(0,a.jsx)(n.td,{children:"Reuse driver instance, not sessions"})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"recommended-indexes",children:"Recommended Indexes"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-cypher",children:"CREATE INDEX accident_id FOR (a:Accident) ON (a.id);\r\nCREATE INDEX accident_timestamp FOR (a:Accident) ON (a.timestamp);\r\nCREATE INDEX camera_id FOR (c:Camera) ON (c.id);\r\nCREATE INDEX road_segment_id FOR (r:RoadSegment) ON (r.id);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/tes/docs/backend/agents/GraphInvestigatorAgent",children:"GraphInvestigatorAgent"})," - Uses Neo4j for GraphRAG"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/tes/docs/backend/routes/accident-routes",children:"Accident Routes"})," - Accident API endpoints"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/tes/docs/backend/routes/correlation-routes",children:"Correlation Routes"})," - Entity correlation endpoints"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://neo4j.com/docs/javascript-manual/current/",children:"Neo4j JavaScript Driver"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://neo4j.com/docs/cypher-manual/current/",children:"Cypher Query Language"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://neo4j.com/docs/cypher-manual/current/functions/spatial/",children:"Neo4j Spatial"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>c});var i=r(6540);const a={},t=i.createContext(a);function s(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);