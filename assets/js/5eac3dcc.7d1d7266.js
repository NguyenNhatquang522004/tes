"use strict";(globalThis.webpackChunkuip_urban_intelligence_platform_docs=globalThis.webpackChunkuip_urban_intelligence_platform_docs||[]).push([[1686],{1285:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>i,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"backend/middlewares/error-handler","title":"Error Handler Middleware","description":"Global Express error handling middleware with structured error responses, logging, and different error type handling.","source":"@site/docs/backend/middlewares/errorHandler.md","sourceDirName":"backend/middlewares","slug":"/backend/middlewares/error-handler","permalink":"/tes/docs/backend/middlewares/error-handler","draft":false,"unlisted":false,"editUrl":"https://github.com/NguyenNhatquang522004/UIP-Urban_Intelligence_Platform/tree/main/apps/traffic-web-app/frontend/docs/docs/backend/middlewares/errorHandler.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"id":"error-handler","title":"Error Handler Middleware","sidebar_label":"Error Handler","sidebar_position":1,"description":"Global Express error handling middleware with structured error responses, logging, and different error type handling.","keywords":["error-handler","middleware","express","exception","structured-errors"]}}');var t=n(4848),o=n(8453);const d={id:"error-handler",title:"Error Handler Middleware",sidebar_label:"Error Handler",sidebar_position:1,description:"Global Express error handling middleware with structured error responses, logging, and different error type handling.",keywords:["error-handler","middleware","express","exception","structured-errors"]},a="Error Handler Middleware",i={},l=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Custom Error Classes",id:"custom-error-classes",level:2},{value:"Usage in Routes",id:"usage-in-routes",level:2},{value:"Error Response Format",id:"error-response-format",level:2},{value:"Development Mode (with stack trace)",id:"development-mode-with-stack-trace",level:3},{value:"Async Handler Wrapper",id:"async-handler-wrapper",level:2},{value:"Registration",id:"registration",level:2},{value:"HTTP Status Codes",id:"http-status-codes",level:2},{value:"Related Documentation",id:"related-documentation",level:2},{value:"References",id:"references",level:2}];function c(r){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...r.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"error-handler-middleware",children:"Error Handler Middleware"})}),"\n",(0,t.jsxs)(e.p,{children:["Global Express ",(0,t.jsx)(e.strong,{children:"error handling middleware"})," with structured error responses, logging, and different error type handling."]}),"\n",(0,t.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-mermaid",children:"graph LR\r\n    A[Route Handler] --\x3e|throw| B[Error Handler]\r\n    B --\x3e C{Error Type}\r\n    C --\x3e|Validation| D[400 Bad Request]\r\n    C --\x3e|Auth| E[401 Unauthorized]\r\n    C --\x3e|NotFound| F[404 Not Found]\r\n    C --\x3e|Rate Limit| G[429 Too Many]\r\n    C --\x3e|Server| H[500 Internal]\r\n    \r\n    D --\x3e I[JSON Response]\r\n    E --\x3e I\r\n    F --\x3e I\r\n    G --\x3e I\r\n    H --\x3e I\n"})}),"\n",(0,t.jsx)(e.h2,{id:"features",children:"Features"}),"\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"Feature"}),(0,t.jsx)(e.th,{children:"Description"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.strong,{children:"Structured Errors"})}),(0,t.jsx)(e.td,{children:"Consistent JSON error format"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.strong,{children:"Error Types"})}),(0,t.jsx)(e.td,{children:"Different handling per error type"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.strong,{children:"Stack Traces"})}),(0,t.jsx)(e.td,{children:"Only in development mode"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.strong,{children:"Logging"})}),(0,t.jsx)(e.td,{children:"Winston integration"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:(0,t.jsx)(e.strong,{children:"Request Context"})}),(0,t.jsx)(e.td,{children:"Include request details"})]})]})]}),"\n",(0,t.jsx)(e.h2,{id:"implementation",children:"Implementation"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"// middlewares/errorHandler.ts\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { logger } from '../utils/logger';\r\n\r\nexport interface AppError extends Error {\r\n  statusCode?: number;\r\n  code?: string;\r\n  details?: any;\r\n  isOperational?: boolean;\r\n}\r\n\r\nexport function errorHandler(\r\n  err: AppError,\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n): void {\r\n  // Default values\r\n  const statusCode = err.statusCode || 500;\r\n  const message = err.message || 'Internal Server Error';\r\n  const code = err.code || 'INTERNAL_ERROR';\r\n  \r\n  // Log error\r\n  const logContext = {\r\n    method: req.method,\r\n    url: req.originalUrl,\r\n    statusCode,\r\n    code,\r\n    stack: err.stack,\r\n    body: req.body,\r\n    query: req.query\r\n  };\r\n  \r\n  if (statusCode >= 500) {\r\n    logger.error(`Server Error: ${message}`, logContext);\r\n  } else {\r\n    logger.warn(`Client Error: ${message}`, logContext);\r\n  }\r\n  \r\n  // Send response\r\n  res.status(statusCode).json({\r\n    error: {\r\n      message,\r\n      code,\r\n      ...(err.details && { details: err.details }),\r\n      ...(process.env.NODE_ENV === 'development' && { \r\n        stack: err.stack \r\n      })\r\n    },\r\n    timestamp: new Date().toISOString(),\r\n    path: req.originalUrl\r\n  });\r\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"custom-error-classes",children:"Custom Error Classes"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"// errors/AppError.ts\r\nexport class AppError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public statusCode: number = 500,\r\n    public code: string = 'INTERNAL_ERROR',\r\n    public details?: any\r\n  ) {\r\n    super(message);\r\n    this.name = 'AppError';\r\n    Error.captureStackTrace(this, this.constructor);\r\n  }\r\n}\r\n\r\n// Specialized errors\r\nexport class ValidationError extends AppError {\r\n  constructor(message: string, details?: any) {\r\n    super(message, 400, 'VALIDATION_ERROR', details);\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n  constructor(resource: string, id?: string) {\r\n    super(\r\n      id ? `${resource} not found: ${id}` : `${resource} not found`,\r\n      404,\r\n      'NOT_FOUND'\r\n    );\r\n  }\r\n}\r\n\r\nexport class UnauthorizedError extends AppError {\r\n  constructor(message = 'Unauthorized') {\r\n    super(message, 401, 'UNAUTHORIZED');\r\n  }\r\n}\r\n\r\nexport class RateLimitError extends AppError {\r\n  constructor(retryAfter?: number) {\r\n    super('Rate limit exceeded', 429, 'RATE_LIMIT', { retryAfter });\r\n  }\r\n}\r\n\r\nexport class ServiceUnavailableError extends AppError {\r\n  constructor(service: string) {\r\n    super(`Service unavailable: ${service}`, 503, 'SERVICE_UNAVAILABLE');\r\n  }\r\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"usage-in-routes",children:"Usage in Routes"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"import { NotFoundError, ValidationError } from '../errors/AppError';\r\n\r\n// Throwing errors\r\nrouter.get('/cameras/:id', async (req, res, next) => {\r\n  try {\r\n    const camera = await stellioService.getEntity(req.params.id);\r\n    \r\n    if (!camera) {\r\n      throw new NotFoundError('Camera', req.params.id);\r\n    }\r\n    \r\n    res.json(camera);\r\n  } catch (error) {\r\n    next(error);  // Pass to error handler\r\n  }\r\n});\r\n\r\n// Validation errors\r\nrouter.post('/cameras', async (req, res, next) => {\r\n  try {\r\n    if (!req.body.name) {\r\n      throw new ValidationError('Camera name is required');\r\n    }\r\n    \r\n    // Create camera...\r\n  } catch (error) {\r\n    next(error);\r\n  }\r\n});\n"})}),"\n",(0,t.jsx)(e.h2,{id:"error-response-format",children:"Error Response Format"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-json",children:'{\r\n  "error": {\r\n    "message": "Camera not found: urn:ngsi-ld:Camera:001",\r\n    "code": "NOT_FOUND",\r\n    "details": null\r\n  },\r\n  "timestamp": "2025-01-15T10:30:00.000Z",\r\n  "path": "/api/cameras/urn:ngsi-ld:Camera:001"\r\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"development-mode-with-stack-trace",children:"Development Mode (with stack trace)"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-json",children:'{\r\n  "error": {\r\n    "message": "Database connection failed",\r\n    "code": "SERVICE_UNAVAILABLE",\r\n    "stack": "Error: Database connection failed\\n    at Neo4jService.connect..."\r\n  },\r\n  "timestamp": "2025-01-15T10:30:00.000Z",\r\n  "path": "/api/correlation/graph"\r\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"async-handler-wrapper",children:"Async Handler Wrapper"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"// utils/asyncHandler.ts\r\nimport { Request, Response, NextFunction, RequestHandler } from 'express';\r\n\r\nexport function asyncHandler(fn: RequestHandler): RequestHandler {\r\n  return (req: Request, res: Response, next: NextFunction) => {\r\n    Promise.resolve(fn(req, res, next)).catch(next);\r\n  };\r\n}\r\n\r\n// Usage\r\nrouter.get('/cameras', asyncHandler(async (req, res) => {\r\n  const cameras = await stellioService.getEntities('Camera');\r\n  res.json(cameras);\r\n  // Errors automatically passed to error handler\r\n}));\n"})}),"\n",(0,t.jsx)(e.h2,{id:"registration",children:"Registration"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-typescript",children:"// server.ts\r\nimport express from 'express';\r\nimport { errorHandler } from './middlewares/errorHandler';\r\n\r\nconst app = express();\r\n\r\n// Routes\r\napp.use('/api/cameras', cameraRoutes);\r\napp.use('/api/weather', weatherRoutes);\r\n// ... other routes\r\n\r\n// 404 handler\r\napp.use((req, res, next) => {\r\n  next(new NotFoundError('Route'));\r\n});\r\n\r\n// Error handler (MUST be last)\r\napp.use(errorHandler);\n"})}),"\n",(0,t.jsx)(e.h2,{id:"http-status-codes",children:"HTTP Status Codes"}),"\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"Code"}),(0,t.jsx)(e.th,{children:"Error Class"}),(0,t.jsx)(e.th,{children:"Description"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"400"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"ValidationError"})}),(0,t.jsx)(e.td,{children:"Invalid request parameters"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"401"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"UnauthorizedError"})}),(0,t.jsx)(e.td,{children:"Missing/invalid authentication"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"403"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"ForbiddenError"})}),(0,t.jsx)(e.td,{children:"Access denied"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"404"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"NotFoundError"})}),(0,t.jsx)(e.td,{children:"Resource not found"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"429"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"RateLimitError"})}),(0,t.jsx)(e.td,{children:"Too many requests"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"500"}),(0,t.jsxs)(e.td,{children:[(0,t.jsx)(e.code,{children:"AppError"})," (default)"]}),(0,t.jsx)(e.td,{children:"Internal server error"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"503"}),(0,t.jsx)(e.td,{children:(0,t.jsx)(e.code,{children:"ServiceUnavailableError"})}),(0,t.jsx)(e.td,{children:"External service down"})]})]})]}),"\n",(0,t.jsx)(e.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/tes/docs/backend/overview",children:"Backend Overview"})," - Server setup"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/tes/docs/backend/utils/logger",children:"Logger"})," - Error logging"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/tes/docs/backend/routes/routes-overview",children:"Routes Overview"})," - API endpoints"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://expressjs.com/en/guide/error-handling.html",children:"Express Error Handling"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status",children:"HTTP Status Codes"})}),"\n"]})]})}function h(r={}){const{wrapper:e}={...(0,o.R)(),...r.components};return e?(0,t.jsx)(e,{...r,children:(0,t.jsx)(c,{...r})}):c(r)}},8453:(r,e,n)=>{n.d(e,{R:()=>d,x:()=>a});var s=n(6540);const t={},o=s.createContext(t);function d(r){const e=s.useContext(o);return s.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function a(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(t):r.components||t:d(r.components),s.createElement(o.Provider,{value:e},r.children)}}}]);