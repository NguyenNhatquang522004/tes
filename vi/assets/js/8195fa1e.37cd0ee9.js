"use strict";(globalThis.webpackChunkuip_urban_intelligence_platform_docs=globalThis.webpackChunkuip_urban_intelligence_platform_docs||[]).push([[8601],{4577:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"backend/services/stellio-service","title":"StellioService - NGSI-LD Client","description":"High-performance TypeScript client for Stellio Context Broker with NGSI-LD entity querying, connection pooling, caching, and retry logic.","source":"@site/docs/backend/services/stellioService.md","sourceDirName":"backend/services","slug":"/backend/services/stellio-service","permalink":"/tes/vi/docs/backend/services/stellio-service","draft":false,"unlisted":false,"editUrl":"https://github.com/NguyenNhatquang522004/UIP-Urban_Intelligence_Platform/tree/main/apps/traffic-web-app/frontend/docs/docs/backend/services/stellioService.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"id":"stellio-service","title":"StellioService - NGSI-LD Client","sidebar_label":"StellioService","sidebar_position":1,"description":"High-performance TypeScript client for Stellio Context Broker with NGSI-LD entity querying, connection pooling, caching, and retry logic.","keywords":["stellio","ngsi-ld","context broker","entity","cache","axios","http pooling"]}}');var i=n(4848),s=n(8453);const a={id:"stellio-service",title:"StellioService - NGSI-LD Client",sidebar_label:"StellioService",sidebar_position:1,description:"High-performance TypeScript client for Stellio Context Broker with NGSI-LD entity querying, connection pooling, caching, and retry logic.",keywords:["stellio","ngsi-ld","context broker","entity","cache","axios","http pooling"]},l="StellioService - NGSI-LD Client",c={},o=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Class Definition",id:"class-definition",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Basic Entity Queries",id:"basic-entity-queries",level:3},{value:"Weather and Air Quality",id:"weather-and-air-quality",level:3},{value:"Geo-Spatial Queries",id:"geo-spatial-queries",level:3},{value:"Entity CRUD Operations",id:"entity-crud-operations",level:3},{value:"Supported Entity Types",id:"supported-entity-types",level:2},{value:"Retry Logic",id:"retry-logic",level:2},{value:"Pagination",id:"pagination",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Performance Tuning",id:"performance-tuning",level:2},{value:"Related Documentation",id:"related-documentation",level:2},{value:"References",id:"references",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"stellioservice---ngsi-ld-client",children:"StellioService - NGSI-LD Client"})}),"\n",(0,i.jsxs)(r.p,{children:["High-performance TypeScript client for ",(0,i.jsx)(r.strong,{children:"Stellio Context Broker"})," providing optimized NGSI-LD entity querying with connection pooling, caching, and retry logic."]}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-mermaid",children:'graph TB\r\n    subgraph StellioService\r\n        CLIENT[Axios Client]\r\n        POOL[Connection Pool]\r\n        CACHE[Entity Cache]\r\n        RETRY[Retry Logic]\r\n    end\r\n    \r\n    subgraph Stellio["Stellio Context Broker"]\r\n        ENTITIES["/ngsi-ld/v1/entities"]\r\n        TYPES["/ngsi-ld/v1/types"]\r\n        SUBS["/ngsi-ld/v1/subscriptions"]\r\n    end\r\n    \r\n    CLIENT --\x3e POOL\r\n    POOL --\x3e ENTITIES\r\n    POOL --\x3e TYPES\r\n    POOL --\x3e SUBS\r\n    CACHE -.-> CLIENT\r\n    RETRY -.-> CLIENT\n'})}),"\n",(0,i.jsx)(r.h2,{id:"features",children:"Features"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Feature"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Entity Querying"})}),(0,i.jsx)(r.td,{children:"Type-based filtering, geo-spatial queries, pagination"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Connection Pooling"})}),(0,i.jsx)(r.td,{children:"50 max sockets, 10 free sockets, 30s keep-alive"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"In-Memory Caching"})}),(0,i.jsx)(r.td,{children:"60s TTL, request deduplication"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Retry Logic"})}),(0,i.jsx)(r.td,{children:"Exponential backoff (3 attempts, 1s initial delay)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"NGSI-LD Support"})}),(0,i.jsx)(r.td,{children:"JSON-LD @context, relationships, property extraction"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-mermaid",children:"sequenceDiagram\r\n    participant Route\r\n    participant Stellio as StellioService\r\n    participant Cache\r\n    participant Broker as Stellio Broker\r\n    \r\n    Route->>Stellio: getCameras(params)\r\n    Stellio->>Cache: Check cache\r\n    alt Cache hit\r\n        Cache--\x3e>Stellio: Return cached data\r\n    else Cache miss\r\n        Stellio->>Broker: GET /entities?type=Camera\r\n        Broker--\x3e>Stellio: NGSI-LD entities\r\n        Stellio->>Cache: Store with TTL\r\n    end\r\n    Stellio--\x3e>Route: Camera[]\n"})}),"\n",(0,i.jsx)(r.h2,{id:"class-definition",children:"Class Definition"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"import axios, { AxiosInstance } from 'axios';\r\nimport http from 'http';\r\nimport https from 'https';\r\n\r\nexport class StellioService {\r\n  private client: AxiosInstance;\r\n  private baseUrl: string;\r\n  private maxRetries: number = 3;\r\n  private retryDelay: number = 1000;\r\n  private cameraCache: Map<string, Camera | null> = new Map();\r\n  private cacheTimeout: number = 60000;\r\n\r\n  constructor();\r\n  \r\n  // Entity Queries\r\n  getCameras(params?: CameraQueryParams): Promise<Camera[]>;\r\n  getCameraById(id: string): Promise<Camera | null>;\r\n  getWeather(params?: WeatherQueryParams): Promise<Weather[]>;\r\n  getAirQuality(params?: AirQualityQueryParams): Promise<AirQuality[]>;\r\n  getAccidents(): Promise<Accident[]>;\r\n  getPatterns(): Promise<TrafficPattern[]>;\r\n  \r\n  // Generic Methods\r\n  getEntities(type: string, params?: Record<string, any>): Promise<any[]>;\r\n  getEntityById(id: string): Promise<any | null>;\r\n  createEntity(entity: any): Promise<void>;\r\n  updateEntity(id: string, attributes: any): Promise<void>;\r\n  deleteEntity(id: string): Promise<void>;\r\n  \r\n  // Pagination\r\n  private fetchAllPaginated(entityType: string, options?: string): Promise<any[]>;\r\n  \r\n  // Retry\r\n  private retryRequest<T>(fn: () => Promise<T>, context: string): Promise<T>;\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Environment Variables\r\nconst config = {\r\n  STELLIO_URL: 'http://localhost:8080',\r\n  STELLIO_NGSI_LD_PATH: '/ngsi-ld/v1'\r\n};\r\n\r\n// Connection Pool Settings\r\nconst httpAgent = new http.Agent({\r\n  keepAlive: true,\r\n  keepAliveMsecs: 30000,\r\n  maxSockets: 50,       // Concurrent connections\r\n  maxFreeSockets: 10,   // Idle connections\r\n  timeout: 30000        // 30s timeout\r\n});\n"})}),"\n",(0,i.jsx)(r.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(r.h3,{id:"basic-entity-queries",children:"Basic Entity Queries"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"import { StellioService } from './services/stellioService';\r\n\r\nconst stellio = new StellioService();\r\n\r\n// Get all cameras\r\nconst cameras = await stellio.getCameras();\r\nconsole.log(`Found ${cameras.length} cameras`);\r\n\r\n// Get cameras near a location\r\nconst nearbyCameras = await stellio.getCameras({\r\n  geometry: { type: 'Point', coordinates: [106.63, 10.82] },\r\n  georel: 'near;maxDistance==5000',\r\n  limit: 50\r\n});\r\n\r\n// Get single camera by ID\r\nconst camera = await stellio.getCameraById('urn:ngsi-ld:Camera:001');\n"})}),"\n",(0,i.jsx)(r.h3,{id:"weather-and-air-quality",children:"Weather and Air Quality"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Get weather observations\r\nconst weather = await stellio.getWeather({\r\n  limit: 10,\r\n  orderBy: 'dateObserved!desc'\r\n});\r\n\r\n// Get air quality with AQI threshold\r\nconst airQuality = await stellio.getAirQuality({\r\n  q: 'aqi>100'  // Only unhealthy AQI\r\n});\n"})}),"\n",(0,i.jsx)(r.h3,{id:"geo-spatial-queries",children:"Geo-Spatial Queries"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Find entities within a polygon\r\nconst entitiesInArea = await stellio.getEntities('Camera', {\r\n  geometry: {\r\n    type: 'Polygon',\r\n    coordinates: [[[106.6, 10.7], [106.8, 10.7], [106.8, 10.9], [106.6, 10.9], [106.6, 10.7]]]\r\n  },\r\n  georel: 'within'\r\n});\r\n\r\n// Find entities near a point\r\nconst nearbyEntities = await stellio.getEntities('WeatherObserved', {\r\n  geometry: { type: 'Point', coordinates: [106.7, 10.8] },\r\n  georel: 'near;maxDistance==10000'  // 10km radius\r\n});\n"})}),"\n",(0,i.jsx)(r.h3,{id:"entity-crud-operations",children:"Entity CRUD Operations"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Create new entity\r\nawait stellio.createEntity({\r\n  id: 'urn:ngsi-ld:Camera:new-001',\r\n  type: 'Camera',\r\n  name: { type: 'Property', value: 'New Camera' },\r\n  location: {\r\n    type: 'GeoProperty',\r\n    value: { type: 'Point', coordinates: [106.65, 10.85] }\r\n  }\r\n});\r\n\r\n// Update entity attributes\r\nawait stellio.updateEntity('urn:ngsi-ld:Camera:001', {\r\n  status: { type: 'Property', value: 'active' }\r\n});\r\n\r\n// Delete entity\r\nawait stellio.deleteEntity('urn:ngsi-ld:Camera:old-001');\n"})}),"\n",(0,i.jsx)(r.h2,{id:"supported-entity-types",children:"Supported Entity Types"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Entity Type"}),(0,i.jsx)(r.th,{children:"NGSI-LD Type"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Camera"}),(0,i.jsx)(r.td,{children:"Camera, TrafficFlowObserved"}),(0,i.jsx)(r.td,{children:"Traffic cameras with image URLs"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Weather"}),(0,i.jsx)(r.td,{children:"WeatherObserved"}),(0,i.jsx)(r.td,{children:"Temperature, humidity, wind"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"AirQuality"}),(0,i.jsx)(r.td,{children:"AirQualityObserved"}),(0,i.jsx)(r.td,{children:"PM2.5, PM10, NO2, O3, CO, SO2, AQI"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"TrafficPattern"}),(0,i.jsx)(r.td,{children:"TrafficFlowObserved"}),(0,i.jsx)(r.td,{children:"Congestion patterns, hotspots"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Accident"}),(0,i.jsx)(r.td,{children:"RoadAccident"}),(0,i.jsx)(r.td,{children:"Accident events with severity"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"CitizenReport"}),(0,i.jsx)(r.td,{children:"CitizenReport"}),(0,i.jsx)(r.td,{children:"User-submitted reports"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"retry-logic",children:"Retry Logic"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-mermaid",children:"graph LR\r\n    A[Request] --\x3e B{Success?}\r\n    B --\x3e|Yes| C[Return Data]\r\n    B --\x3e|No| D{Attempt < 3?}\r\n    D --\x3e|Yes| E[Wait 1s * 2^attempt]\r\n    E --\x3e A\r\n    D --\x3e|No| F[Throw Error]\n"})}),"\n",(0,i.jsx)(r.p,{children:"Exponential backoff formula:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"delay = retryDelay * 2^(attempt - 1)\n"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Attempt 1: 1s delay"}),"\n",(0,i.jsx)(r.li,{children:"Attempt 2: 2s delay"}),"\n",(0,i.jsx)(r.li,{children:"Attempt 3: 4s delay"}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"pagination",children:"Pagination"}),"\n",(0,i.jsx)(r.p,{children:"Stellio has a hard limit of 100 entities per request. The service automatically handles pagination:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"private async fetchAllPaginated(\r\n  entityType: string,\r\n  options: string = 'keyValues'\r\n): Promise<any[]> {\r\n  const allEntities: any[] = [];\r\n  const batchSize = 100;\r\n  let offset = 0;\r\n  let hasMore = true;\r\n\r\n  while (hasMore) {\r\n    const batch = await this.client.get('/entities', {\r\n      params: { type: entityType, limit: batchSize, offset, options }\r\n    });\r\n    \r\n    allEntities.push(...batch.data);\r\n    hasMore = batch.data.length === batchSize;\r\n    offset += batchSize;\r\n    \r\n    // Safety limit: max 100,000 entities\r\n    if (offset > 100000) break;\r\n  }\r\n\r\n  return allEntities;\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"try {\r\n  const cameras = await stellio.getCameras();\r\n} catch (error) {\r\n  if (axios.isAxiosError(error)) {\r\n    if (error.response?.status === 404) {\r\n      console.log('No cameras found');\r\n    } else if (error.response?.status === 503) {\r\n      console.log('Stellio service unavailable');\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"performance-tuning",children:"Performance Tuning"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Parameter"}),(0,i.jsx)(r.th,{children:"Default"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"maxSockets"})}),(0,i.jsx)(r.td,{children:"50"}),(0,i.jsx)(r.td,{children:"Maximum concurrent connections"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"maxFreeSockets"})}),(0,i.jsx)(r.td,{children:"10"}),(0,i.jsx)(r.td,{children:"Idle connections to keep"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"timeout"})}),(0,i.jsx)(r.td,{children:"30000"}),(0,i.jsx)(r.td,{children:"Request timeout (ms)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"cacheTimeout"})}),(0,i.jsx)(r.td,{children:"60000"}),(0,i.jsx)(r.td,{children:"Cache TTL (ms)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"maxRetries"})}),(0,i.jsx)(r.td,{children:"3"}),(0,i.jsx)(r.td,{children:"Retry attempts"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"retryDelay"})}),(0,i.jsx)(r.td,{children:"1000"}),(0,i.jsx)(r.td,{children:"Initial retry delay (ms)"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/tes/vi/docs/backend/services/data-aggregator",children:"DataAggregator"})," - Uses StellioService for polling"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/tes/vi/docs/backend/routes/camera-routes",children:"Camera Routes"})," - Camera API endpoints"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/tes/vi/docs/backend/routes/weather-routes",children:"Weather Routes"})," - Weather API endpoints"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/docs/architecture/ngsi-ld",children:"NGSI-LD Overview"})," - NGSI-LD data model"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/stellio-hub/stellio-context-broker",children:"Stellio Context Broker"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://www.etsi.org/deliver/etsi_gs/CIM/001_099/009/01.06.01_60/gs_cim009v010601p.pdf",children:"NGSI-LD Specification"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://smartdatamodels.org/",children:"Smart Data Models"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>l});var t=n(6540);const i={},s=t.createContext(i);function a(e){const r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);