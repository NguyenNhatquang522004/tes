"use strict";(globalThis.webpackChunkuip_urban_intelligence_platform_docs=globalThis.webpackChunkuip_urban_intelligence_platform_docs||[]).push([[7241],{8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var t=r(6540);const i={},a=t.createContext(i);function s(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:n},e.children)}},8942:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>g,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"backend/utils/api-key-rotation","title":"API Key Rotation","description":"Secure API key rotation utility for external service credentials with automatic rotation schedules and encrypted storage.","source":"@site/docs/backend/utils/apiKeyRotation.md","sourceDirName":"backend/utils","slug":"/backend/utils/api-key-rotation","permalink":"/tes/vi/docs/backend/utils/api-key-rotation","draft":false,"unlisted":false,"editUrl":"https://github.com/NguyenNhatquang522004/UIP-Urban_Intelligence_Platform/tree/main/apps/traffic-web-app/frontend/docs/docs/backend/utils/apiKeyRotation.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"api-key-rotation","title":"API Key Rotation","sidebar_label":"API Key Rotation","sidebar_position":2,"description":"Secure API key rotation utility for external service credentials with automatic rotation schedules and encrypted storage.","keywords":["api-key","rotation","security","gemini","credentials","encryption"]}}');var i=r(4848),a=r(8453);const s={id:"api-key-rotation",title:"API Key Rotation",sidebar_label:"API Key Rotation",sidebar_position:2,description:"Secure API key rotation utility for external service credentials with automatic rotation schedules and encrypted storage.",keywords:["api-key","rotation","security","gemini","credentials","encryption"]},o="API Key Rotation",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Features",id:"features",level:2},{value:"Class Definition",id:"class-definition",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Get Current API Key",id:"get-current-api-key",level:3},{value:"Manual Key Rotation",id:"manual-key-rotation",level:3},{value:"Add New Key",id:"add-new-key",level:3},{value:"Check Expiration",id:"check-expiration",level:3},{value:"Rotation Strategy",id:"rotation-strategy",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Key Validation",id:"key-validation",level:2},{value:"Usage Tracking",id:"usage-tracking",level:2},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Related Documentation",id:"related-documentation",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"api-key-rotation",children:"API Key Rotation"})}),"\n",(0,i.jsxs)(n.p,{children:["Secure ",(0,i.jsx)(n.strong,{children:"API key rotation"})," utility for managing external service credentials with automatic rotation schedules and secure storage."]}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mermaid",children:'graph TB\r\n    subgraph KeyManager["API Key Manager"]\r\n        STORE[Key Store]\r\n        ROTATE[Rotation Logic]\r\n        VALIDATE[Key Validator]\r\n    end\r\n    \r\n    subgraph External["External Services"]\r\n        GEMINI[Google Gemini]\r\n        TAVILY[Tavily Search]\r\n        TICKETMASTER[Ticketmaster]\r\n    end\r\n    \r\n    subgraph Agents\r\n        ECO[EcoTwinAgent]\r\n        GRAPH[GraphInvestigator]\r\n        MAESTRO[TrafficMaestro]\r\n    end\r\n    \r\n    Agents --\x3e STORE\r\n    STORE --\x3e External\r\n    ROTATE --\x3e STORE\r\n    VALIDATE --\x3e STORE\n'})}),"\n",(0,i.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Feature"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Key Rotation"})}),(0,i.jsx)(n.td,{children:"Scheduled key rotation (weekly/monthly)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Multi-Key Support"})}),(0,i.jsx)(n.td,{children:"Pool of keys for load distribution"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Validation"})}),(0,i.jsx)(n.td,{children:"Test key validity before use"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Fallback"})}),(0,i.jsx)(n.td,{children:"Automatic fallback to backup keys"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Rate Limiting"})}),(0,i.jsx)(n.td,{children:"Track usage per key"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Audit Logging"})}),(0,i.jsx)(n.td,{children:"Log all key operations"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"class-definition",children:"Class Definition"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface ApiKey {\r\n  id: string;\r\n  value: string;\r\n  service: string;\r\n  createdAt: Date;\r\n  expiresAt: Date;\r\n  usageCount: number;\r\n  lastUsed: Date;\r\n  isActive: boolean;\r\n}\r\n\r\nexport class ApiKeyRotation {\r\n  private keys: Map<string, ApiKey[]>;\r\n  private currentIndex: Map<string, number>;\r\n  \r\n  // Key Management\r\n  getKey(service: string): string;\r\n  rotateKey(service: string): void;\r\n  addKey(service: string, key: string): void;\r\n  removeKey(service: string, keyId: string): void;\r\n  \r\n  // Validation\r\n  validateKey(service: string, key: string): Promise<boolean>;\r\n  \r\n  // Monitoring\r\n  getUsageStats(service: string): KeyUsageStats;\r\n  checkExpiration(): ExpiredKey[];\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// config/apiKeys.ts\r\nexport const keyConfig = {\r\n  gemini: {\r\n    rotationInterval: 7 * 24 * 60 * 60 * 1000, // 7 days\r\n    maxUsagePerKey: 10000,\r\n    keys: process.env.GEMINI_API_KEYS?.split(',') || []\r\n  },\r\n  tavily: {\r\n    rotationInterval: 30 * 24 * 60 * 60 * 1000, // 30 days\r\n    maxUsagePerKey: 5000,\r\n    keys: process.env.TAVILY_API_KEYS?.split(',') || []\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(n.h3,{id:"get-current-api-key",children:"Get Current API Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { apiKeyRotation } from '../utils/apiKeyRotation';\r\n\r\n// Get active key for Gemini\r\nconst geminiKey = apiKeyRotation.getKey('gemini');\r\n\r\n// Use in agent\r\nconst genAI = new GoogleGenerativeAI(geminiKey);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"manual-key-rotation",children:"Manual Key Rotation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Force rotation (e.g., after rate limit hit)\r\napiKeyRotation.rotateKey('gemini');\r\n\r\n// Get new key\r\nconst newKey = apiKeyRotation.getKey('gemini');\n"})}),"\n",(0,i.jsx)(n.h3,{id:"add-new-key",children:"Add New Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Add key dynamically\r\napiKeyRotation.addKey('gemini', 'AIza...');\r\n\r\n// Validate before adding\r\nconst isValid = await apiKeyRotation.validateKey('gemini', 'AIza...');\r\nif (isValid) {\r\n  apiKeyRotation.addKey('gemini', 'AIza...');\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"check-expiration",children:"Check Expiration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Check for expiring keys\r\nconst expiringKeys = apiKeyRotation.checkExpiration();\r\n\r\nexpiringKeys.forEach(key => {\r\n  logger.warn(`Key expiring soon: ${key.service}/${key.id}`);\r\n  // Send notification\r\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"rotation-strategy",children:"Rotation Strategy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-mermaid",children:"flowchart TD\r\n    A[Request API Key] --\x3e B{Current key valid?}\r\n    B --\x3e|Yes| C{Usage limit reached?}\r\n    C --\x3e|No| D[Return current key]\r\n    C --\x3e|Yes| E[Rotate to next key]\r\n    B --\x3e|No| E\r\n    E --\x3e F{More keys available?}\r\n    F --\x3e|Yes| G[Set next key as current]\r\n    F --\x3e|No| H[Error: No valid keys]\r\n    G --\x3e D\n"})}),"\n",(0,i.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# .env\r\n# Multiple keys separated by comma\r\nGEMINI_API_KEYS=AIza...,AIza...,AIza...\r\nTAVILY_API_KEYS=tvly...,tvly...\r\nTICKETMASTER_API_KEY=abc123\r\n\r\n# Rotation settings\r\nAPI_KEY_ROTATION_ENABLED=true\r\nAPI_KEY_ROTATION_INTERVAL=604800000  # 7 days in ms\n"})}),"\n",(0,i.jsx)(n.h2,{id:"key-validation",children:"Key Validation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"async validateKey(service: string, key: string): Promise<boolean> {\r\n  switch (service) {\r\n    case 'gemini':\r\n      try {\r\n        const genAI = new GoogleGenerativeAI(key);\r\n        const model = genAI.getGenerativeModel({ model: 'gemini-pro' });\r\n        await model.generateContent('test');\r\n        return true;\r\n      } catch {\r\n        return false;\r\n      }\r\n      \r\n    case 'tavily':\r\n      try {\r\n        const response = await fetch('https://api.tavily.com/health', {\r\n          headers: { 'X-API-Key': key }\r\n        });\r\n        return response.ok;\r\n      } catch {\r\n        return false;\r\n      }\r\n      \r\n    default:\r\n      return false;\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"usage-tracking",children:"Usage Tracking"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface KeyUsageStats {\r\n  service: string;\r\n  totalKeys: number;\r\n  activeKeys: number;\r\n  totalUsage: number;\r\n  usageByKey: Record<string, number>;\r\n  rotationCount: number;\r\n  lastRotation: Date;\r\n}\r\n\r\n// Get stats\r\nconst stats = apiKeyRotation.getUsageStats('gemini');\r\nconsole.log(`Total Gemini usage: ${stats.totalUsage}`);\r\nconsole.log(`Keys rotated: ${stats.rotationCount} times`);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Never commit keys to git"})," - Use environment variables"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Encrypt at rest"})," - Store encrypted in production"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Audit logging"})," - Log all key operations"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Rate limiting"})," - Track usage per key"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Expiration alerts"})," - Notify before expiry"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/tes/vi/docs/backend/agents/EcoTwinAgent",children:"EcoTwinAgent"})," - Uses Gemini API"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/tes/vi/docs/backend/agents/GraphInvestigatorAgent",children:"GraphInvestigatorAgent"})," - Uses Tavily API"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/tes/vi/docs/backend/utils/logger",children:"Logger"})," - Audit logging"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://owasp.org/www-project-api-security/",children:"OWASP API Security"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://cloud.google.com/secret-manager/docs/best-practices",children:"Secret Management Best Practices"})}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);